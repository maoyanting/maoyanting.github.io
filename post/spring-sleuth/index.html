<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.57.2" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Spring-sleuth &middot; ä¿®ä»™ä¸‹å±å§”å‘˜ä¼š</title>

  
  <link type="text/css" rel="stylesheet" href="https://maoyanting.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://maoyanting.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://maoyanting.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://maoyanting.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">



  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="ä¿®ä»™ä¸‹å±å§”å‘˜ä¼š" />

  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://maoyanting.com/"><h1>ä¿®ä»™ä¸‹å±å§”å‘˜ä¼š</h1></a>
      <p class="lead">
      å‰ç»™æ’æ°´å·¥ç¨‹å¸ˆç°ç¨‹åºåª› 
      <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://maoyanting.com/">Home</a> </li>
        <li><a href="https://maoyanting.com//categories/index.html">Categories</a> </li>
        <li><a href="https://maoyanting.com//about/index.html">About Me</a> </li>
        <li><a href="/posts/"> Blog </a></li><li><a href="/categories/"> Categories </a></li><li><a href="/about"> About </a></li>
      </ul>
    </nav>

    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Spring-sleuth</h1>
  <div id="toc" class="well col-md-4 col-sm-6">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a></li>
<li><a href="#ä¸ºä»€ä¹ˆæ—¥å¿—æ²¡æœ‰æ‰“å°å‡ºæ¥id">ä¸ºä»€ä¹ˆæ—¥å¿—æ²¡æœ‰æ‰“å°å‡ºæ¥id</a></li>
<li><a href="#è·å–å½“å‰çš„traceid">è·å–å½“å‰çš„traceId</a></li>
</ul></li>
</ul>
</nav>
    </div>
  <time datetime=2018-10-22T22:49:08Z class="post-date">Mon, Oct 22, 2018</time>
  <p>æœ‰æ—¶å€™ï¼Œå®šä½bugçœŸçš„æ˜¯ä¸ªå¾ˆéº»çƒ¦çš„äº‹æƒ…å‘¢</p>

<p>æˆ‘ä»¬å¯ä»¥ç®€å•å€Ÿç”¨ä¸€ä¸‹Spring Cloud Sleuth</p>

<h2 id="å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</h2>

<pre><code class="language-xml">&lt;dependencyManagement&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-sleuth&lt;/artifactId&gt;
            &lt;version&gt;2.0.1.RELEASE&lt;/version&gt;
            &lt;type&gt;pom&lt;/type&gt;
            &lt;scope&gt;import&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/dependencyManagement&gt;
&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-sleuth&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>

<p>è¿™é‡Œæ³¨æ„ä¸€ä¸‹ <code>version</code>  ï¼Œæœ‰æ—¶å€™ä¼šå¯¼è‡´ä¾èµ–è¿›ä¸æ¥</p>

<p>å¥½äº†ï¼Œè¿™å°±å¯ä»¥äº†ğŸ˜œï¼ŒçœŸçš„éå¸¸ç®€å•è€Œä¸”æ²¡æœ‰ä¾µå…¥æ€§</p>

<p>æ­¤æ—¶æ‰“å°å‡ºæ¥çš„æ—¥å¿—å¤§æ¦‚æ˜¯è¿™æ ·çš„</p>

<pre><code>2018-10-22 23:03:14.029  INFO [-,,,] 12936 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8081 (http) with context path '/sandao'
2018-10-22 23:03:14.039  INFO [-,,,] 12936 --- [           main] com.sandao.DemoSandaoApplication         : Started DemoSandaoApplication in 9.364 seconds (JVM running for 10.336)
</code></pre>

<p>è¿™é‡Œæ¥å› ä¸ºæ˜¯å¯åŠ¨æ—¥å¿—ï¼Œæ‰€ä»¥æ²¡æœ‰traceIdå’ŒspanId</p>

<p>è¿™é‡Œæˆ‘ä»¬å€Ÿç”¨å¯åŠ¨ç±»è°ƒç”¨ä¸€ä¸‹æ¥å£</p>

<pre><code class="language-java">@RestController
@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
public class DemoSandaoApplication {

	public static void main(String[] args) {
		SpringApplication.run(DemoSandaoApplication.class, args);
	}

	private static final Logger logger = LoggerFactory.getLogger(DemoSandaoApplication.class);

	@RequestMapping(&quot;/log&quot;)
	public String home() {
		logger.info(&quot;Handling home&quot;);
		return &quot;Hello World&quot;;
	}
}
</code></pre>

<p>æ‰“å°å‡ºæ¥çš„æ—¥å¿—å¤§æ¦‚æ˜¯è¿™æ ·çš„</p>

<pre><code>2018-10-22 23:06:29.838  INFO [-,30f87869bf24ede4,30f87869bf24ede4,false] 12936 --- [nio-8081-exec-2] com.sandao.DemoSandaoApplication         : Handling home
</code></pre>

<p>æˆ‘ä»¬å°±å¯ä»¥çœ‹è§ä¸¤ä¸ªidäº†</p>

<hr />

<p>æœ‰äº›æ•™ç¨‹ä¼šå»ºè®®ä½ ï¼ˆåŒ…æ‹¬å®˜æ–¹æ–‡æ¡£ï¼‰åœ¨ <code>application.yml</code> / <code>application.properties</code> é‡Œé¢åŠ ä¸Šé¡¹ç›®çš„åç§°</p>

<p>æ¯”å¦‚ <code>application.yml</code>ï¼š</p>

<pre><code class="language-yaml">spring:
  application:
    name: sandao
</code></pre>

<p>è¿™æ—¶å€™æ‰“å°å‡ºæ¥çš„æ—¥å¿—å¤§æ¦‚æ˜¯è¿™æ ·çš„</p>

<pre><code>2018-10-22 23:00:23.209  INFO [sandao,,,] 9280 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8081 (http) with context path '/sandao'
2018-10-22 23:00:23.221  INFO [sandao,,,] 9280 --- [           main] com.sandao.DemoSandaoApplication         : Started DemoSandaoApplication in 17.512 seconds (JVM running for 19.017)
</code></pre>

<h2 id="ä¸ºä»€ä¹ˆæ—¥å¿—æ²¡æœ‰æ‰“å°å‡ºæ¥id">ä¸ºä»€ä¹ˆæ—¥å¿—æ²¡æœ‰æ‰“å°å‡ºæ¥id</h2>

<p>é¦–å…ˆçœ‹ä¸€ä¸‹ä½ çš„ä¾èµ–å¯¼è¿›æ¥æ²¡æœ‰</p>

<p>ç„¶åä½ çœ‹ä¸€ä¸‹ä½ æ˜¯ä¸æ˜¯é…ç½®äº†æ—¥å¿—çš„æ ¼å¼ï¼Œå¦‚æœé…ç½®äº†æ—¥å¿—çš„æ ¼å¼ï¼Œå°±éœ€è¦æ˜¾å¼åœ°å†™å‡ºæ¥ <code>traceId</code> å’Œ <code>spanId</code> ï¼Œæˆ‘å½“æ—¶è¢«è¿™ä¸ªå‘äº†å¾ˆä¹…â€¦â€¦</p>

<pre><code class="language-xml">&lt;configuration&gt;
    &lt;!-- TraceId:ä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªid --&gt;
    &lt;property name=&quot;CONSOLE_LOG_PATTERN&quot;
              value=&quot;%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [ %X{X-B3-TraceId:-} %X{X-B3-SpanId:-}] %logger{5} - %msg%n&quot;/&gt;

    &lt;appender name=&quot;rollingAppender&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;file&gt;${LOG_PATH}/doct.log&lt;/file&gt;
        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
            &lt;fileNamePattern&gt;/logs/heuristic-%d{yyyy-MM-dd}.log&lt;/fileNamePattern&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
        &lt;/rollingPolicy&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;${CONSOLE_LOG_PATTERN}&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
        &lt;append&gt;false&lt;/append&gt;
        &lt;prudent&gt;false&lt;/prudent&gt;
    &lt;/appender&gt;

    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;${CONSOLE_LOG_PATTERN}&lt;/pattern&gt;
            &lt;charset&gt;utf8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;root level=&quot;info&quot;&gt;
        &lt;appender-ref ref=&quot;STDOUT&quot;/&gt;
        &lt;appender-ref ref=&quot;rollingAppender&quot;/&gt;
    &lt;/root&gt;

&lt;/configuration&gt;
</code></pre>

<h2 id="è·å–å½“å‰çš„traceid">è·å–å½“å‰çš„traceId</h2>

<p><code>sleuth</code> å¤šç”¨äºåˆ†éƒ¨ç½²ç³»ç»Ÿï¼Œå’Œ <code>zipkin</code> é…åˆä½¿ç”¨ï¼Œä¸è¿‡æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¹Ÿéœ€è¦åœ¨é¡¹ç›®ä¸­è·å–traceIdï¼Œå¯ä»¥å‚è€ƒä¸‹è¿°çš„æ–¹å¼ã€‚</p>

<pre><code class="language-java">import brave.Tracer;

@Service
public class Breadcrumb {

  @Autowired
  private Tracer tracer;

  public String breadcrumbId() {
    return tracer.currentSpan().context().traceIdString();
  }
}
</code></pre>
</div>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
